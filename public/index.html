<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>文件上传与进度查看</title>
    <style>
        .upload-section,
        .records-section {
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }

        .progress-bar {
            background: #f0f0f0;
            height: 20px;
        }

        .progress {
            background: #4caf50;
            height: 100%;
        }
    </style>
</head>

<body>
    <div class="upload-section">
        <h2>文件上传</h2>
        <form id="uploadForm" action="your-upload-script.php" method="post" enctype="multipart/form-data"
            onsubmit="return upload(event)">
            <input type="file" id="excelFile" name="excelFile" accept=".xlsx,.xls">
            <span> 用户ID</span> <input type="text" name="userId" value="">
            <span> 商品ID</span> <input type="text" name="goodsId" value="">
            <button type="submit">开始上传</button>
        </form>
    </div>
    <div id="progress"></div>
    <div class="records-section">
        <h2>上传记录</h2>
        <table id="recordsTable">
            <thead>
                <tr>
                    <th>文件名</th>
                    <th>状态</th>
                    <th>上传时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="progressModal" style="display:none;">
        <h3>处理进度</h3>
        <div class="progress-bar">
            <div class="progress" style="width:0%"></div>
        </div>
        <div id="progressDetails"></div>
        <button onclick="closeModal()">关闭</button>
    </div>

    <script>
        let currentTaskWs = null;

        // 页面加载时获取上传记录
        document.addEventListener('DOMContentLoaded', fetchRecords);

        async function fetchRecords() {
            try {
                const res = await fetch('/records');
                if (!res.ok) throw new Error('获取上传记录失败');
                const data = await res.json();
                renderRecords(data.data);
            } catch (error) {
                alert(`获取上传记录失败: ${error.message}`);
            }
        }

        function renderRecords(records) {
            console.log(records);
            const tbody = document.querySelector('#recordsTable tbody');
            tbody.innerHTML = records.map(record => `
                <tr>
                    <td>${escapeHtml(record.file_name)}</td>
                    <td>${escapeHtml(record.status)}</td>
                    <td>${record.create_time}</td>
                    <td>
                        ${record.status === 'processing' ?
                    `<button onclick="showProgressModal('${escapeHtml(record.task_id)}')">查看进度</button>` :
                    ''
                }
                    </td>
                </tr>
            `).join('');
        }



        function upload(event) {
            event.preventDefault(); // 阻止表单默认提交行为

            const form = document.getElementById('uploadForm');
            const formData = new FormData(form);

            fetch('http://localhost:2345/upload', {
                method: 'POST',
                body: formData,
            })
                .then(res => {
                    if (!res.ok) throw new Error('上传失败');
                    return res.json();
                })
                .then(data => {
                    if (data.data?.taskId) {
                        alert(`上传成功`);
                        fetchRecords(); // 新增记录列表刷新
                    }
                })
                .catch(error => {
                    alert(`上传失败: ${error.message}`);
                });
        }
        function showProgressModal(taskId) {
            currentTaskId = taskId;
            const progressModal = document.getElementById('progressModal');
            progressModal.style.display = 'block';

            if (!currentTaskWs) {
                currentTaskWs = new WebSocket(`ws://localhost:2346`);
                currentTaskWs.onopen = () => {
                    currentTaskWs.send(JSON.stringify({ taskId }));
                };
                currentTaskWs.onmessage = function (event) {
                    const progressData = JSON.parse(event.data);
                    const progressDiv = document.querySelector('#progressModal .progress');
                    progressDiv.style.width = `${progressData.progress}%`;
                    document.getElementById('progressDetails').innerText = `进度: ${progressData.progress}%`;
                };

                currentTaskWs.onclose = function () {
                    currentTaskWs = null;
                };
            }
        }

        function closeModal() {
            const progressModal = document.getElementById('progressModal');
            progressModal.style.display = 'none';

            // 关闭WebSocket连接
            if (currentTaskWs) {
                currentTaskWs.close();
                currentTaskWs = null;
            }
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>

</html>